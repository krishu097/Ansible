---
# 0) Pre-flight: make sure upstream facts exist
- name: Assert inputs from VPC/SG/IAM roles
  assert:
    that:
      - private_subnet_ids is defined
      - private_subnet_ids | length > 0
      - eks_controlplane_sg_id is defined
      - eks_workernodes_sg_id is defined
      - eks_cluster_role_arn is defined
      - eks_nodegroup_role_arn is defined
    fail_msg: >
      Missing required inputs from upstream roles. Ensure 'vpc', 'sg', and 'iam'
      run before 'eks' in the same play.

###########################################
# 1) Create / Update EKS Cluster
###########################################
- name: Create / Update EKS Cluster
  community.aws.eks_cluster:
    name: "{{ eks_cluster_name }}"
    region: "{{ aws_region }}"
    version: "{{ eks_version }}"
    role_arn: "{{ eks_cluster_role_arn }}"
    resources_vpc_config:
      subnetIds: "{{ private_subnet_ids }}"
      securityGroupIds:
        - "{{ eks_controlplane_sg_id }}"
      endpointPublicAccess: "{{ endpoint_public_access }}"
      endpointPrivateAccess: "{{ endpoint_private_access }}"
      publicAccessCidrs: "{{ public_access_cidrs }}"
    logging: "{{ cluster_logging }}"
    tags: "{{ eks_cluster_tags }}"
    wait_timeout: "{{ cluster_create_timeout }}"
    state: present
  register: eks_cluster

###########################################
# 2) Create / Update Launch Template (attach Worker SG)
###########################################
- name: Create / Update Launch Template for Node Group (no SSH, Session Manager only)
  amazon.aws.ec2_launch_template:
    name: "lt-{{ nodegroup_name }}"
    region: "{{ aws_region }}"
    state: present
    network_interfaces:
      - device_index: 0
        delete_on_termination: true
        groups:
          - "{{ eks_workernodes_sg_id }}"
    tag_specifications:
      - resource_type: instance
        tags: "{{ nodegroup_tags }}"
      - resource_type: volume
        tags: "{{ nodegroup_tags }}"
  register: lt_result

###########################################
# 3) Create / Update EKS Managed Node Group
###########################################
- name: Create / Update EKS Node Group
  community.aws.eks_nodegroup:
    region: "{{ aws_region }}"
    cluster_name: "{{ eks_cluster_name }}"
    name: "{{ nodegroup_name }}"
    node_role_arn: "{{ eks_nodegroup_role_arn }}"
    subnets: "{{ private_subnet_ids }}"
    launch_template:
      name: "lt-{{ nodegroup_name }}"
      version: "$Latest"
    scaling_config:
      min_size: "{{ nodegroup_min_size }}"
      max_size: "{{ nodegroup_max_size }}"
      desired_size: "{{ nodegroup_desired_size }}"
    disk_size: "{{ nodegroup_disk_size }}"
    instance_types: "{{ nodegroup_instance_types }}"
    ami_type: "{{ nodegroup_ami_type }}"
    capacity_type: "{{ nodegroup_capacity_type }}"
    labels: "{{ nodegroup_labels }}"
    taints: "{{ nodegroup_taints }}"
    tags: "{{ nodegroup_tags }}"
    wait: true
    wait_timeout: "{{ nodegroup_create_timeout }}"
    state: present
  register: eks_nodegroup

###########################################
# 4) Helpful Output
###########################################
- name: Debug EKS Artifacts
  debug:
    msg:
      - "Cluster: {{ eks_cluster_name }} / Version: {{ eks_version }}"
      - "Control Plane SG: {{ eks_controlplane_sg_id }}"
      - "Worker SG: {{ eks_workernodes_sg_id }}"
      - "Private Subnets: {{ private_subnet_ids | join(', ') }}"
      - "Cluster Role: {{ eks_cluster_role_arn }}"
      - "Nodegroup Role: {{ eks_nodegroup_role_arn }}"
      - "Nodegroup: {{ nodegroup_name }} (desired={{ nodegroup_desired_size }})"
