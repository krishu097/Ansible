---
- name: Discover VPC details by tag
  amazon.aws.ec2_vpc_net_info:
    region: "{{ aws_region }}"
    filters:
      "tag:Environment": "{{ env_name }}"
  register: vpc_info

- name: Set VPC ID
  set_fact:
    vpc_id: "{{ vpc_info.vpcs[0].id }}"

- name: Discover private subnets by tag
  amazon.aws.ec2_vpc_subnet_info:
    region: "{{ aws_region }}"
    filters:
      vpc-id: "{{ vpc_id }}"
      "tag:Tier": "private"
  register: subnet_info

- name: Set private subnets fact
  set_fact:
    private_subnets: "{{ subnet_info.subnets | map('extract', {'id':'id', 'availability_zone':'availability_zone'}) | list }}"

- name: Render eksctl cluster config
  template:
    src: eksctl-cluster.yaml.j2
    dest: "{{ playbook_dir }}/eksctl-cluster.yaml"
  vars:
    eks_version: "{{ eks_version }}"
    nodegroup_instance_type: "{{ nodegroup_instance_types[0] }}"
    nodegroup_desired_size: "{{ nodegroup_desired_size }}"
    nodegroup_min_size: "{{ nodegroup_min_size }}"
    nodegroup_max_size: "{{ nodegroup_max_size }}"
    nodegroup_disk_size: "{{ nodegroup_disk_size }}"

- name: Run eksctl to create EKS cluster
  command: eksctl create cluster -f "{{ playbook_dir }}/eksctl-cluster.yaml"
  register: eksctl_output
  changed_when: "'created' in eksctl_output.stdout"

- name: Show eksctl output
  debug:
    var: eksctl_output.stdout
