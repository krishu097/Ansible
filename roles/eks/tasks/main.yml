---
- name: Discover VPC details by tag
  amazon.aws.ec2_vpc_net_info:
    region: "{{ aws_region }}"
    filters:
      "tag:Environment": "{{ env_name }}"
  register: vpc_info

- name: Set VPC ID
  set_fact:
    vpc_id: "{{ vpc_info.vpcs[0].id }}"

- name: Discover private subnets by tag
  amazon.aws.ec2_vpc_subnet_info:
    region: "{{ aws_region }}"
    filters:
      vpc-id: "{{ vpc_id }}"
      "tag:Tier": "private"
  register: subnet_info

- name: Set private subnets fact (az/id only, sorted, max 2)
  set_fact:
    private_subnets: "{{ (subnet_info.subnets | json_query('[].{az: availability_zone, id: id}')) | sort(attribute='az') | slice(2) | first | default([]) }}"
  when: subnet_info.subnets is defined

- name: Derive nodegroup_instance_type for template
  set_fact:
    nodegroup_instance_type: "{{ (nodegroup_instance_types | first) | default('t3.medium') }}"

- name: Render eksctl cluster config
  template:
    src: eksctl-cluster.yaml.j2
    dest: "{{ playbook_dir }}/eksctl-cluster.yaml"

- name: Run eksctl to create EKS cluster
  command: eksctl create cluster -f "{{ playbook_dir }}/eksctl-cluster.yaml"
  register: eksctl_output
  changed_when: "'created' in eksctl_output.stdout"

- name: Show eksctl output
  debug:
    var: eksctl_output.stdout
